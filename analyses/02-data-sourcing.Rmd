---
title: "SCORE: Siedner et al. (2020) replication"
subtitle: "Data sourcing"
author: "Radoslaw Panczak"
date: "`r format(Sys.time(), '%d %B, %Y')`"
mainfont: DejaVu Sans
output: 
  html_document: 
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    theme: united 
    highlight: pygments 
editor_options: 
  chunk_output_type: console
---

<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.width=8, fig.height=6, dpi=300, 
                      out.width="800px", out.height="600px")

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman) 
p_load(tidyverse, scales, janitor, tabulizer, stringr)
```

# Timing of state's measures

```{r}
# page 4 needs headers
measures_4 <- extract_tables("data-raw/supplement/2020.04.03.20052373-1.pdf",
                             pages = 4, guess = TRUE, 
                             output = "data.frame") %>% 
  pluck(1) %>% 
  clean_names() %>% 
  filter(state != "") %>% 
  select(-source_s)

# some column drama
measures_8 <- extract_tables("data-raw/supplement/2020.04.03.20052373-1.pdf",
                             pages = 8, guess = FALSE, 
                             output = "data.frame") %>% 
  pluck(1) %>% 
  clean_names() %>% 
  filter(x != "") %>% 
  select(- x_7) %>% 
  mutate(x_6 = "")

names(measures_8) <- names(measures_4)

# these at least are consistent
for (page in c(5:7, 9:10)){
  
  temp  <- extract_tables("data-raw/supplement/2020.04.03.20052373-1.pdf",
                          pages = page, guess = FALSE, 
                          output = "data.frame") %>% 
    pluck(1) %>% 
    clean_names() %>% 
    filter(x != "") %>% 
    select(-x_7, -x_8)
  
  names(temp) <- names(measures_4)
  
  if (page == 5) {
    measures_5_10 <- temp
  } else {
    measures_5_10 <- bind_rows(measures_5_10, temp)
  }
}

# another drama
measures_11 <- extract_tables("data-raw/supplement/2020.04.03.20052373-1.pdf",
                              pages = 11, guess = FALSE, 
                              output = "data.frame") %>% 
  pluck(1) %>% 
  clean_names() %>% 
  filter(x != "") %>% 
  select(-x_6, -x_7) %>% 
  filter(word(x, 1) != "Notes:") %>% 
  filter(word(x, 1) != "of") %>% 
  mutate(state = word(x, end = -2),
         date = word(x, start = -1)) %>% 
  select(-x) %>% 
  relocate(state, date)

names(measures_11) <- names(measures_4)

# all together
measures <- bind_rows(measures_4, 
                      measures_5_10,
                      measures_8, 
                      measures_11) %>% 
  pivot_longer(cols = a:e,
               names_to = "measure_short",
               values_to = "present") %>% 
  filter(present != "") %>% 
  select(-present) %>% 
  mutate(date = as.Date(date, format = "%m/%d/%y")) %>% 
  mutate(
    measure = case_when(
      measure_short == "a" ~ "closure of schools",
      measure_short == "b" ~ "closure of workplaces",
      measure_short == "c" ~ "cancellation of public events",
      measure_short == "d" ~ "restrictions on internal movement",
      measure_short == "e" ~ "closure of state borders"
    )) %>% 
  filter(state != "Puerto Rico") %>% 
  arrange(state, date)

# str(measures)
# View(measures)
sjmisc::frq(measures, measure, sort.frq = "desc")
sjmisc::frq(measures, state)

# (missing <- anti_join(
#    as_tibble(unique(measures$state)), 
#    as_tibble(unique(nyt$state))
# ))

write_rds(measures, "data/supplement/measures.Rds")
write_csv(measures, "data/supplement/measures.csv")
```

Prepared dataset consists of `r number(nrow(measures))` records of `r number(length(unique(measures$state)))` states with measures implemented between `r min(measures$date)` to `r max(measures$date)`. 

# NYT Covid-19 data

The New York Times' [Coronavirus (Covid-19) Data in the United States](https://github.com/nytimes/covid-19-data/) repository containing 

> a series of data files with cumulative counts of coronavirus cases in the United States, at the state and county level, over time.

```{r}
urlfile="https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"

nyt_raw <- read_csv(url(urlfile))

# sjmisc::frq(nyt_raw, state)

write_rds(nyt_raw, "data-raw/nyt/nyt_raw.Rds")
write_csv(nyt_raw, "data-raw/nyt/nyt_raw.csv")
```

Raw dataset downloaded on `r format(Sys.time(), '%d %B, %Y')` consists of `r number(nrow(nyt_raw), big.mark = ",")` records of `r number(length(unique(nyt_raw$state)))` states from `r min(nyt_raw$date)` to `r max(nyt_raw$date)`. 

Data are then limited to the 50 states plus DC, time frame of the analysis ie. until `2020-03-30` and daily number of cases are derived from cumulative counts. Next cases from previous day are added to each observation and logarithms and their difference are calculated. Finally only days when cumulative number of cases reached 30 are kept in the dataset.

```{r}
# nyt_raw %>% filter(fips %in% c(66, 69, 72, 78)) %>% group_by(state) %>% slice(1)

nyt <- nyt_raw %>%
  filter(!fips %in% c(66, 69, 72, 78)) %>% 
  select(-fips, -deaths) %>%
  rename(cases_cumulative = cases) %>%
  filter(date <= as.Date("2020-03-30")) %>%
  group_by(state) %>%
  mutate(cases_day = cases_cumulative - lag(cases_cumulative)) %>%
  mutate(cases_day = ifelse(is.na(cases_day), cases_cumulative, cases_day)) %>%
  mutate(cases_day_perc = (cases_day / lag(cases_day)) *100,
         cases_daybefore = lag(cases_day)) %>%
  ungroup() %>%
  mutate(cases_day_ln = log(cases_day),
         cases_daybefore_ln = log(cases_daybefore),
         log_dif = cases_day_ln - cases_daybefore_ln) %>%
  filter(cases_cumulative >= 30) %>%
  arrange(state, date)
```

Prepared dataset consists of `r number(nrow(nyt), big.mark = ",")` records of `r number(length(unique(nyt$state)))` states from `r min(nyt$date)` to `r max(nyt$date)` period. 
```{r}
write_rds(nyt, "data/nyt/nyt.Rds")
write_csv(nyt, "data/nyt/nyt.csv")
```

# Pop density
